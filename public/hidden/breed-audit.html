<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>PetRx Breed Avatar Audit</title>
        <style>
            :root {
                color-scheme: light;
            }
            body {
                font-family:
                    ui-sans-serif,
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Helvetica,
                    Arial;
                margin: 0;
                padding: 20px;
                background: #0b1020;
                color: #e8eefc;
            }
            .wrap {
                max-width: 1100px;
                margin: 0 auto;
            }
            h1 {
                margin: 0 0 14px;
                font-size: 20px;
                font-weight: 700;
            }

            .controls {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                align-items: end;
            }
            label {
                display: block;
                font-size: 12px;
                opacity: 0.85;
                margin-bottom: 6px;
            }
            select,
            input {
                width: 100%;
                padding: 10px 12px;
                border-radius: 10px;
                border: 1px solid rgba(255, 255, 255, 0.12);
                background: rgba(255, 255, 255, 0.06);
                color: #e8eefc;
            }
            option {
                color: #111;
            }
            .note {
                margin-top: 10px;
                font-size: 12px;
                opacity: 0.75;
            }

            /* Keep the two panels 50/50 on desktop */
            .panel {
                margin-top: 18px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 14px;
            }

            .card {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 14px;
                padding: 14px;
                min-width: 0;
            }
            .card h2 {
                margin: 0 0 10px;
                font-size: 14px;
                font-weight: 700;
                opacity: 0.9;
                display: flex;
                justify-content: space-between;
                gap: 10px;
                flex-wrap: wrap;
            }
            .badge {
                font-size: 12px;
                padding: 3px 10px;
                border-radius: 999px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .err {
                color: #ffb4b4;
                border-color: rgba(255, 180, 180, 0.35);
            }

            /* Prevent giant refs from hijacking the layout */
            .imgwrap {
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                height: clamp(220px, 42vh, 360px);
                background: rgba(0, 0, 0, 0.18);
                border-radius: 12px;
                border: 1px dashed rgba(255, 255, 255, 0.14);
                overflow: hidden;
            }
            img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                display: block;
            }

            .placeholder {
                position: absolute;
                inset: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 16px;
                text-align: center;
                font-size: 13px;
                opacity: 0.85;
            }
            .placeholder strong {
                font-weight: 800;
            }
            .placeholder small {
                display: block;
                margin-top: 6px;
                opacity: 0.75;
            }

            .meta {
                margin-top: 10px;
                font-size: 12px;
                opacity: 0.85;
                line-height: 1.35;
                word-break: break-word;
            }
            .meta a {
                color: #9cc1ff;
                text-decoration: none;
            }
            .meta a:hover {
                text-decoration: underline;
            }
            .row {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-top: 10px;
            }
            .btn {
                cursor: pointer;
                padding: 8px 10px;
                border-radius: 10px;
                border: 1px solid rgba(255, 255, 255, 0.12);
                background: rgba(255, 255, 255, 0.08);
                color: #e8eefc;
                font-size: 12px;
            }
            .btn:active {
                transform: translateY(1px);
            }

            @media (max-width: 820px) {
                .controls {
                    grid-template-columns: 1fr;
                }
                .panel {
                    grid-template-columns: 1fr;
                } /* on mobile, stack (otherwise it's unusable) */
                .imgwrap {
                    height: clamp(200px, 36vh, 320px);
                }
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <h1>Breed Avatar Audit</h1>

            <div class="controls">
                <div>
                    <label>Species</label>
                    <select id="species">
                        <option value="dogs">Dogs</option>
                        <option value="cats">Cats</option>
                    </select>
                </div>
                <div>
                    <label>Breed (type to filter)</label>
                    <input
                        id="filter"
                        placeholder="e.g. Dachshund, Mixed Breed, Maine Coon..."
                        autocomplete="off"
                    />
                </div>
                <div style="grid-column: 1 / -1">
                    <label>Pick breed</label>
                    <select id="breed"></select>
                    <div class="note">
                        Left = reference (thumb). Right = avatar from
                        <code>/assets/breed-avatars/{species}/{value}.png</code>
                        (falls back to default when missing).
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="card">
                    <h2>
                        <span>Reference</span>
                        <span class="badge" id="refStatus">—</span>
                    </h2>
                    <div class="imgwrap">
                        <img id="refImg" alt="Reference image" />
                        <div
                            class="placeholder"
                            id="refPlaceholder"
                            style="display: none"
                        ></div>
                    </div>
                    <div class="meta" id="refMeta"></div>
                </div>

                <div class="card">
                    <h2>
                        <span>Avatar</span>
                        <span class="badge" id="avatarStatus">—</span>
                    </h2>
                    <div class="imgwrap">
                        <img id="avatarImg" alt="Avatar image" />
                        <div
                            class="placeholder"
                            id="avatarPlaceholder"
                            style="display: none"
                        ></div>
                    </div>
                    <div class="meta" id="avatarMeta"></div>
                    <div class="row">
                        <button class="btn" id="openAvatar">
                            Open avatar in new tab
                        </button>
                        <button class="btn" id="openRef">
                            Open reference in new tab
                        </button>
                        <button class="btn" id="copyValue">Copy value</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Put these two JSON files next to this HTML file, OR update the paths below.
            const BREED_DATA_URL = "./breedData.json";
            const BREED_META_URL = "./breedMeta.json";

            // If a breed avatar is missing, we show a default image instead.
            // Assumption: you have (or will add) these two files:
            //   /assets/breed-avatars/dogs/default.png
            //   /assets/breed-avatars/cats/default.png
            // If you keep them somewhere else, change defaultAvatarUrl().
            function defaultAvatarUrl(species) {
                return `/assets/breed-avatars/${species}/default.png`;
            }

            const el = (id) => document.getElementById(id);
            const speciesSel = el("species");
            const filterInp = el("filter");
            const breedSel = el("breed");

            const refImg = el("refImg");
            const avatarImg = el("avatarImg");

            const refStatus = el("refStatus");
            const avatarStatus = el("avatarStatus");

            const refMeta = el("refMeta");
            const avatarMeta = el("avatarMeta");

            const refPlaceholder = el("refPlaceholder");
            const avatarPlaceholder = el("avatarPlaceholder");

            const openAvatarBtn = el("openAvatar");
            const openRefBtn = el("openRef");
            const copyValueBtn = el("copyValue");

            let breedData = null;
            let breedMeta = null;

            function escapeHtml(s) {
                return (s || "").replace(
                    /[&<>"']/g,
                    (c) =>
                        ({
                            "&": "&amp;",
                            "<": "&lt;",
                            ">": "&gt;",
                            '"': "&quot;",
                            "'": "&#39;",
                        })[c],
                );
            }

            function avatarUrl(species, value) {
                return `/assets/breed-avatars/${species}/${value}.png`;
            }

            function getMeta(species, value) {
                return breedMeta?.[species]?.[String(value)] || null;
            }

            function getThumb(species, value) {
                const m = getMeta(species, value);
                return m?.thumbnailUrl || m?.imageUrl || "";
            }

            function getPageUrl(species, value) {
                const m = getMeta(species, value);
                return m?.pageUrl || "";
            }

            function showPlaceholder(which, html) {
                const p = which === "ref" ? refPlaceholder : avatarPlaceholder;
                p.innerHTML = html;
                p.style.display = "flex";
            }
            function hidePlaceholder(which) {
                const p = which === "ref" ? refPlaceholder : avatarPlaceholder;
                p.style.display = "none";
                p.innerHTML = "";
            }

            function setBadge(badgeEl, text, isErr) {
                badgeEl.textContent = text;
                badgeEl.classList.toggle("err", !!isErr);
            }

            function clearImage(imgEl) {
                imgEl.onload = null;
                imgEl.onerror = null;
                imgEl.removeAttribute("src");
                imgEl.style.display = "none";
            }

            function showImage(imgEl) {
                imgEl.style.display = "block";
            }

            // Reference logic:
            // - If there's no thumb URL at all => "Prompted" and show placeholder text (no blank broken img).
            // - If there *is* a thumb URL => attempt to load; if blocked/missing show placeholder.
            function renderReference(species, value) {
                const thumb = getThumb(species, value);

                if (!thumb) {
                    clearImage(refImg);
                    setBadge(refStatus, "Prompted", false);
                    showPlaceholder(
                        "ref",
                        "<div><strong>Prompted</strong><small>No reference image for this breed.</small></div>",
                    );
                    return;
                }

                hidePlaceholder("ref");
                setBadge(refStatus, "Loading…", false);

                refImg.onload = () => {
                    setBadge(refStatus, "OK", false);
                    hidePlaceholder("ref");
                };
                refImg.onerror = () => {
                    clearImage(refImg);
                    setBadge(refStatus, "Missing / blocked", true);
                    showPlaceholder(
                        "ref",
                        "<div><strong>Missing / blocked</strong><small>Reference URL failed to load.</small></div>",
                    );
                };
                showImage(refImg);
                refImg.src = thumb;
            }

            // Avatar logic:
            // - Try breed avatar first
            // - If missing => show default and badge "Default"
            // - If default also missing => show placeholder
            function renderAvatar(species, value) {
                const url = avatarUrl(species, value);
                const fallback = defaultAvatarUrl(species);

                hidePlaceholder("avatar");
                setBadge(avatarStatus, "Loading…", false);

                avatarImg.onload = () => {
                    // If we landed on the fallback, we label it "Default"
                    if (avatarImg.dataset.fallback === "1") {
                        setBadge(avatarStatus, "Default", false);
                    } else {
                        setBadge(avatarStatus, "OK", false);
                    }
                    hidePlaceholder("avatar");
                };

                avatarImg.onerror = () => {
                    // first failure => try default
                    if (avatarImg.dataset.fallback === "1") {
                        clearImage(avatarImg);
                        setBadge(avatarStatus, "Missing", true);
                        showPlaceholder(
                            "avatar",
                            "<div><strong>Missing</strong><small>Breed avatar and default avatar are both missing.</small></div>",
                        );
                        return;
                    }
                    avatarImg.dataset.fallback = "1";
                    showImage(avatarImg);
                    avatarImg.src = fallback;
                };

                avatarImg.dataset.fallback = "0";
                showImage(avatarImg);
                avatarImg.src = url;
            }

            function renderMeta(species, value) {
                const m = getMeta(species, value) || {};
                const label =
                    (breedData?.[species] || []).find((b) => b.value === value)
                        ?.label || "";
                const pageUrl = m.pageUrl || "";
                const thumb = m.thumbnailUrl || m.imageUrl || "";

                refMeta.innerHTML = [
                    `<div><strong>${escapeHtml(label)}</strong> <span style="opacity:.7">(${species} • ${value})</span></div>`,
                    pageUrl
                        ? `<div>Wiki: <a href="${escapeHtml(pageUrl)}" target="_blank" rel="noreferrer">open</a></div>`
                        : `<div style="opacity:.6">Wiki: —</div>`,
                    thumb
                        ? `<div style="opacity:.6">Thumb: ${escapeHtml(thumb)}</div>`
                        : `<div style="opacity:.6">Thumb: —</div>`,
                ].join("");

                const aUrl = avatarUrl(species, value);
                const dUrl = defaultAvatarUrl(species);

                avatarMeta.innerHTML = [
                    `<div><strong>${escapeHtml(label)}</strong> <span style="opacity:.7">(${species} • ${value})</span></div>`,
                    `<div>Breed avatar: <a href="${escapeHtml(aUrl)}" target="_blank" rel="noreferrer">open</a></div>`,
                    `<div style="opacity:.7">Default avatar: <a href="${escapeHtml(dUrl)}" target="_blank" rel="noreferrer">open</a></div>`,
                ].join("");
            }

            function rebuildBreedOptions() {
                const species = speciesSel.value;
                const list = (breedData?.[species] || []).slice();

                const q = (filterInp.value || "").trim().toLowerCase();
                const filtered = q
                    ? list.filter(
                          (b) =>
                              (b.label || "").toLowerCase().includes(q) ||
                              String(b.value).includes(q),
                      )
                    : list;

                breedSel.innerHTML = "";
                for (const b of filtered) {
                    const opt = document.createElement("option");
                    opt.value = String(b.value);
                    opt.textContent = `${b.label} (${b.value})`;
                    breedSel.appendChild(opt);
                }

                if (filtered.length) {
                    const prev = breedSel.dataset.prevValue;
                    if (
                        prev &&
                        filtered.some((b) => String(b.value) === prev)
                    ) {
                        breedSel.value = prev;
                    }
                    onSelectChange();
                } else {
                    setBadge(refStatus, "—", false);
                    setBadge(avatarStatus, "—", false);
                    clearImage(refImg);
                    clearImage(avatarImg);
                    hidePlaceholder("ref");
                    hidePlaceholder("avatar");
                    refMeta.textContent = "";
                    avatarMeta.textContent = "";
                }
            }

            function onSelectChange() {
                const species = speciesSel.value;
                const value = Number(breedSel.value);
                if (!value) return;

                breedSel.dataset.prevValue = String(value);

                renderReference(species, value);
                renderAvatar(species, value);
                renderMeta(species, value);

                const pageUrl = getPageUrl(species, value);
                const thumb = getThumb(species, value);
                const aUrl = avatarUrl(species, value);

                openAvatarBtn.onclick = () => window.open(aUrl, "_blank");
                openRefBtn.onclick = () =>
                    window.open(pageUrl || thumb || "about:blank", "_blank");
                copyValueBtn.onclick = async () => {
                    try {
                        await navigator.clipboard.writeText(String(value));
                        copyValueBtn.textContent = "Copied!";
                        setTimeout(
                            () => (copyValueBtn.textContent = "Copy value"),
                            900,
                        );
                    } catch (e) {
                        alert("Clipboard blocked. Value: " + value);
                    }
                };
            }

            async function init() {
                const [bd, bm] = await Promise.all([
                    fetch(BREED_DATA_URL).then((r) => r.json()),
                    fetch(BREED_META_URL).then((r) => r.json()),
                ]);
                breedData = bd;
                breedMeta = bm;

                speciesSel.addEventListener("change", () => {
                    filterInp.value = "";
                    rebuildBreedOptions();
                });
                filterInp.addEventListener("input", () =>
                    rebuildBreedOptions(),
                );
                breedSel.addEventListener("change", onSelectChange);

                rebuildBreedOptions();
            }

            init().catch((err) => {
                document.body.innerHTML =
                    "<pre style='white-space:pre-wrap;padding:20px;color:#fff;background:#111'>Failed to load JSON.\n\n" +
                    (err?.stack || err) +
                    "</pre>";
            });
        </script>
    </body>
</html>
